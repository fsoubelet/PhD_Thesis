\chapter{Optics Studies and Software Developments}
\label{chapter:Others_and_Software}

\todo{Write a short intro here. Do not format the body before having this written.}

\section{Phase Error Dependency on BPM Type and Location in the LHC}

In the LHC and many other circular colliders BPM measurement data constitutes the primary source for optics properties computation.
These measurements and the subsequent results were suspected to be substantially affected by both the type of BPM used for the measurements and the value of the \(\beta\)-functions are the measuring devices.
This study was performed to investigate the influence of these properties on the reconstructed phase value from turn-by-turn data.

In practice the presence of systematic errors can influence different sets of measurements to not be totally independent, but in the following study these are assumed to be independent and identically distributed normal random variables (IID), meaning repeating the same BPM measurement in identical conditions will spawn a range of values forming a Gaussian distribution.
Using the underlying properties of the measurements-derived distributions, one can numerically infer the standard deviation on the phase measurement. \todo{Also mention that this differentiates based on the conditions mentioned above.}

\subsection{Measurement Data and Underlying Distributions}

The methods and considerations below can be applied on BPM turn-by-turn measurement data from synchrotron machines.
The following analysis was done on data taken during the LHC Run~\num{2}, in \num{2018} and at \(\beta^{\ast} =\)~\qty{30}{\centi\meter}.
Information about the measurement data used for this analysis can be found in \cref{appendix:measurement_fills}.

The suspicions mentioned above come from the fact that different BPM types have different resolution, and higher \(\beta\)-functions lead to better signal-to-noise ratios on measurements.
\todo{Have a ref on this?}
As can be seen in \cref{figure:bpms_betas_histogram}, measuring BPMs are spread across a wide range of \(\beta\)-functions.
It is therefore of interest to have the ability to determine the standard deviation on the phase measurement while differentiating on BPM types and \(\beta\)-functions.

\begin{figure}[!htb]
    \centering
    \includegraphics*[width=\textwidth]{Figures/Other_Studies/bpms_betas_histogram.pdf}
    \caption{Distribution of BPM \(\beta\)-functions across the machine for the Run~\num{2} measurements used. A small amount of BPMs located at much higher \(\beta\) are not shown on this plot.}
    \label{figure:bpms_betas_histogram}
\end{figure}

The sum of two IIDs - which our measurements are assumed to be - is also normal.
Using the characteristic function of a normal distribution

\begin{equation}
    \varphi(t) = \exp \left( it \mu - \frac{\sigma^2 t^2}{2} \right) \text{ ,}
    \label{equations:normal_distribution_characteristic_function}
\end{equation}
and given that the characteristic function of the sum of two independent random variables \(X\) and \(Y\) is the product of their respective characteristic functions, one gets:

\begin{equation}
    \begin{aligned}
        \varphi_{X+Y}(t) = \varphi_{X}(t) \varphi_{Y}(t) &= \exp \left( it \mu_{X} - \frac{\sigma_{X}^2 t^2}{2} \right) \exp \left(it \mu_{Y} - \frac{\sigma_{Y}^2 t^2}{2} \right)  \text{ ,} \\
                                                         &= \exp \left( it \left( \mu_{X} + \mu_{Y} \right) - \frac{\left( \sigma_{X}^2 + \sigma_{Y}^2 \right) t^2}{2} \right)  \text{ ,}
    \end{aligned}
\end{equation}
which corresponds to a normal distribution with its mean being the sum of the two means, and its variance being the sum of the two variances.
Respectively, one can deduce the same for the subtraction of two IIDs by changing the signs.

In particle accelerators, phase advances are measured from BPM to BPM and are, in the simplest form, the result of a subtraction.
As a consequence the repeated phase advance measurements obtained from a given BPM pair form a normal distribution with average phase advance \(\bar{\varphi}\) and standard deviation \(\sigma_{\mu}\).
Traditionally, the error on phase advance is computed via the standard deviation of \(N\) measurements:

\begin{equation}
    \varepsilon^2 = \frac{1}{N} \sum_{i=1}^{N}\big(\varphi_{i} - \bar{\varphi} \big)^2 \text{ .}
    \label{equation:phase_error_calculation}
\end{equation}

This means the squares of phase advance (and phase advance error) values \(\varepsilon^2\) form a chi-square distribution, with a number of degrees of freedom  \(k = N - 1\) since the sample mean is subtracted.
Therefore, grouping sufficient BPM pairs of the same type and with similar \(\beta\)-function, and computing the distribution of their \(\varepsilon^2\) one obtains a chi-square distribution.
\Cref{figure:square_errors_histograms} shows those chi-square distributions for different ranges of \(\beta\)-functions combinations between measuring BPMs.

\begin{figure}[!htb]
    \centering
    \includegraphics*[width=\textwidth]{Figures/Other_Studies/phase_errors_squared_distributions.pdf}
    \caption{Distribution of the squares of phase measurement errors for different BPM combinations, differentiated by the \(\beta\)-functions at the locations of the measuring BPMs. The different distributions form chi-square distributions. For this plot a few simple categories were established, and a BPM is considered "low" below \(\beta =\)~\qty{100}{\meter}, "high" above \(\beta =\)~\qty{200}{\meter} and "medium" in between.}
    \label{figure:square_errors_histograms}
\end{figure}

Similarly, the positive real square roots of values from this chi-square distribution form a chi distribution, which can be derived with a change of variable \(x=y^2\).
\Cref{figure:phase_errors_histograms} shows these distributions for the same \(\beta\)-function ranges seen in \cref{figure:square_errors_histograms}.

\begin{figure}[!htb]
    \centering
    \includegraphics*[width=\textwidth]{Figures/Other_Studies/phase_errors_distributions.pdf}
    \caption{Distribution of the phase measurement errors for different BPM combinations, differentiated by the \(\beta\)-functions at the locations of the measuring BPMs. For this plot a few simple categories were established, and a BPM is considered "low" below \(\beta =\)~\qty{100}{\meter}, "high" above \(\beta =\)~\qty{200}{\meter} and "medium" in between.}
    \label{figure:phase_errors_histograms}
\end{figure}

\subsection{Computing the Standard Deviation on Phase Advance Measurements}

A chi-square distribution with \(k\) degrees of freedom  is the distribution of sum of the squares of \(k\) independent standard normal random variables.
Let \(X_{i}\) represent the \(N\) normal random variables, then the associated standard deviation square is given by:

\begin{equation}
    \sigma^{2} = \frac{1}{N} \sum_{i=1}^{N} \left( X_{i} - \bar{X} \right)^{2} \text{ ,}
    \label{equation:chi2_dist_build_from_normals}
\end{equation}
where \(\bar{X}\) is the sample mean of the normal distribution given by

\begin{equation}
    \bar{X} = \frac{1}{N} \sum_{i=1}^{N} X_{i} \text{ .}
    \label{equation:normal_mean}
\end{equation}

The standard error used in analysis codes is defined as

\begin{equation}
    (SE)^{2} = \frac{1}{N-1} \sum_{i=1}^{N} \left( X_{i} - \bar{X} \right)^{2} \text{ .}
    \label{equation:omc3_standard_error}
\end{equation}

The ensemble of \(\sigma^{2}\) values from different sets of measurements form a chi-square distribution. 
The associated Probability Density Function (PDF) for \(k\) degrees of freedom, which is non-zero for positive values only, is given by:

\begin{equation}
    P(x \geq 0, k) = \frac{x^{k/2-1} e^{-x/2}} {2^{k/2} \Gamma(\frac{k}{2})} \text{ .}
    \label{equation:chi2_pdf_equation}
\end{equation}

The \intro{mode} is the value \(x^{*}\) that maximizes the PDF.
In this case, one can notice that for positive values where the PDF is defined, \(x^{*}\) will be the same for \(P(x)\) and \(\log P(x)\).
When adopting the following convention:

\begin{equation}
    \centering
    A(x) = \log P(x) \mbox{,   and  } C =
    \tikz[baseline]{
        \node[draw=red,rounded corners,anchor=base] (m5)
        {\(\displaystyle - \frac{k}{2} \log(2) - \log \Gamma(k/2)\)};
        \node[below of=m5] (12) {constant};
        \draw[-,red] (12) -- (m5)
    } \text{ ,}
    \label{equation:chi2_pdf_derivation_convention}
\end{equation}
one can deduce the value \(x^{*}\) through a simple derivation:

\begin{equation}
	\begin{aligned}
    A(x)              &= C + \left( \frac{k}{2} - 1 \right) \log(x) - \frac{x}{2} \text{ ,} \\
    \frac{d A(x)}{dx} &= \left( \frac{k}{2} - 1 \right) \frac{1}{x} - \frac{1}{2} = \frac{k - 2 - x}{2x} \text{ .}
	\end{aligned}	
    \label{equation:chi2_pdf_mode_proof}
\end{equation}

Thus, we get that the mode is \(x^{*} = k - 2\).
If \(k \leq 2\) then the mode is 0, since the PDF in that case is strictly decreasing with \(x\).
\Cref{figure:chisquare_demo_fit} illustrates this property with a generated chi-square distribution and its PDF, highlighting the determined location of the mode from a distribution fit.

\begin{figure}[!htb]
    \centering
    \includegraphics*[width=\textwidth]{Figures/Other_Studies/phase_chisquare_demo_fit.pdf}
    \caption{A randomly generated chi-square distribution with \(k = 4\) degrees of freedom, and a numerically fit probability density function. The determined mode is indeed located at \(k - 2 = 2\). Here 'df' (degrees of freedom), 'loc' (horizontal offset) and 'scale' (a scaling factor) are parameters determined during the fit. The horizontal axis is in units of sigmas square.}
    \label{figure:chisquare_demo_fit}
\end{figure}

The standard deviation of the phase measurements \(\sigma_{\mu}\) is then given from the mode by:

\begin{equation}
    \sigma_{\mu} = \sqrt{\frac{(\epsilon^2)^*}{k - 2}} = \sqrt{\frac{(\epsilon^2)^*}{N - 3}} \text{ .}
    \label{equation:stdev_from_chi2_mode}
\end{equation}

For the chi distribution mentioned above and derived through \(x = y^2\), the associated probability density function of \cref{equation:chi2_pdf_equation} becomes:

\begin{equation}
    \begin{aligned}
        P_{\sigma}(y , k) &= P (y^2 , k) 2y \text{ ,} \\
        P_{\sigma}(y , k) &= \frac{y^{k-1} e^{-y^2/2}} {2^{k/2-1} \Gamma(\frac{k}{2})} \text{ .}
    \end{aligned}
    \label{equation:chi_pdf}  
\end{equation}

For this chi distribution, the mode of \(P_{\sigma}(y , k)\) is at \(y^*=\sqrt{k-1}\) and \cref{equation:stdev_from_chi2_mode} above becomes:

\begin{equation}
    \sigma_{\mu} = \frac{y^*}{\sqrt{k - 1}} = \frac{y^*}{\sqrt{N - 2}} \text{ .}
    \label{equation:stdev_from_mode}
\end{equation}

However, for non-perfect distributions it is numerically difficult to accurately detect this mode: one can use the mode of a fitted probability density function (as done in \cref{figure:chisquare_demo_fit} on a perfect chi-square distribution) but suffer from the quality of the fit, or try to detect the highest bins from the distribution's histogram but suffer from bin resolution and outlier data points skewing the result.

It is possible to use other properties than the mode.
For instance, similarly shown as previously for the mode, one can compute back the desired standard deviation using the mean of the chi distribution through:

\begin{equation}
	\begin{aligned}
        \sigma_{\mu} &= \frac{\mu}{T} \text{ ,} \\
        T            &= \sqrt{2} \frac{\Gamma((k + 1) / 2)}{\Gamma(k / 2)} \text{ ,}
	\end{aligned}	
    \label{equation:stdev_from_chi_mean}
\end{equation}
where \(\sigma_{\mu}\) is the phase measurement's standard deviation, \(\mu\) is the chi distribution's mean, \(k\) is the chi distribution's degrees of freedom and \(\Gamma\) is the Gamma function.

\subsection{Application to Measurements}

Due to the presence of many outliers (see \cref{figure:bpms_betas_histogram}) and the lack of a sufficient number of data points in some BPM type categories, the calculation from the mean of the chi distribution seen in \cref{equation:stdev_from_chi_mean} was used in the results presented below.

Optics analysis was run on turn-by-turn data, and BPMs were categorized based on their types~\cite{CERN:Equipment_Codes} and the value of \(\beta\)-functions at their locations.
Both the chi distributions and the chi-square distributions are generated as detailed above, respectively from the phase advance standard errors and from the square of these errors.
\Cref{figure:grid_distributions_standard_standard} shows the distributions of phase errors for different \(\beta\)-functions combinations among so-called \textit{standard} BPMs, the most common ones in the LHC.

\begin{figure}[!htb]
    \centering
    \includegraphics*[width=\textwidth]{Figures/Other_Studies/phase_grid_distributions_errors_standard_standard.pdf}
    \caption{Phase error distributions for different BPM \(\beta\) combinations, for \textit{standard} to \textit{standard} type BPMs.}
    \label{figure:grid_distributions_standard_standard}
\end{figure}

For each of these cases, the mean of the distribution is computed and the calculation from \cref{equation:stdev_from_chi_mean} is used.
Depending on parameters set for the optics analysis one might have to apply a correcting factor of \(\sqrt{N-1}\) - with \(N\) being the number of measurements used for the analysis - to compensate for this factor being already present in calculations performed by the analysis software.
Namely, choosing to ignore \(t\)-value correction and single file uncertainty makes this factor appear in the optics calculations and requires to leave it out in later on analysis.
Values inferred with this method for an LHC Run~\num{2} for \textit{standard} type BPMs can be seen in \cref{figure:phase_error_heatmap_standard_bpms}.
Similarly, BPMs placed at higher \(\beta\)-functions offer better results.
Results for all BPM types were also computed but are not shown.% can be seen in Fig.~\ref{fig:stripline_error_heatmap} and Fig.~\ref{fig:warm_error_heatmap}.
These are in line expectations: BPM types with lower resolution such as warm BPMs or wide-aperture BPMs offer a higher standard deviation.

\begin{figure}[!htb]
    \centering
    \includegraphics*[width=\textwidth]{Figures/Other_Studies/phase_stdev_heatmap_mrad_standard_standard.pdf}
    \caption{Computed standard deviation on phase advance measurements between \textit{standard} to \textit{standard} type BPMs for the LHC Run~\num{2} (\num{2018}, \(\beta^{\ast} =\)~\qty{30}{\centi\meter}) for different \(\beta\)-functions combinations of these BPMs.}
    \label{figure:phase_error_heatmap_standard_bpms}
\end{figure}

\subsection{Conclusions}

\todo{Using the normal nature of Beam Position Monitor measurements, one can make use of the underlying properties of the chi-square and chi statistical distributions in order to compute the standard deviation of phase measurement.
The suspected dependency of the measurement's standard deviation on both measuring BPMs' types and their \(\beta\)-functions are confirmed.
The ability to accurately compute key statistical values on phase advance measurements - but also potentially a number of optics values later on computed from phase - while differentiating on BPM type opens up potential applications in analysis algorithms, for instance helping the refining of phase accuracy from the new Harpy harmonic analysis code, or optimizing BPM selection in the N-BPM measurement method or in corrections.}

\section{Simulations of Sextupolar Contribution to Amplitude Detuning in the LHC}

\todo{Write / include a small section on amplitude detuning in the theory chapter.}
\cite{PRAB:White:Direct_Amplitude_Detuning_AC_Dipole}

Blah blah.

\section{OMC Software Developments}

Blah blah.

\section{Summary}

Blah blah.
