\chapter{Relevant Theory of Beam Dynamics}
\label{chapter:theory}

The design, operation, performance, and safety of a particle accelerator depend on the \gls{beam} dynamics.
This chapter provides an overview of the beam dynamics theories relevant to the material in this thesis, and more specifically beam \gls{optics}.
For a more complete treatment of relevant accelerator physics the reader is best referred to textbooks by Wilson~\cite{BOOK:Wilson:Introcution_Particle_Accelerators}, Lee~\cite{BOOK:Lee:Accelerator_physics}, Wiedemann~\cite{BOOK:Wiedemann:Particle_Accelerator_Physics}, Minty and Zimmermann~\cite{BOOK:Minty:Measurements_Control_Charged_Particle_Beams}, Wolski~\cite{BOOK:Wolski:Beam_dynamics} or Chao~\cite{BOOK:Chao:Handbook_Accelerator_Physics_Engineering, BOOK:Chao:Collective_instabilities}.
Most of the material herein can be found in the aforementioned literature, and when not in these works explicit references to the relevant content are given.

This chapter starts out with a description of linear dynamics and a parametrization of turn-by-turn motion in a circular accelerator.
It then moves on to aspects of non-linear dynamics and the use of normal form to obtain the non-linear motion and introduce \glspl{RDT}, then follows with an introduction to \gls{betatron_coupling} and ends with a discussion of \gls{luminosity}.

%----------------------------------------------------------------------------------------

\section{Linear Beam Dynamics}
\label{section:linear_beam_dynamics}

The linear dynamics of an accelerator are, mainly, the endeavor to bend and focus particle \glspl{beam} to confine them within the machine's aperture.

\subsection{Transport and Guiding of Charged Particles}
\label{subsection:transport_and_guiding_of_charged_particles}

To force the beam's particles into a closed trajectory, they are subjected to magnetic fields that deflect their trajectories.
The force exerted onto the beam is the Lorentz force \(F_{L}\) given by the equation:

\begin{equation}
    \vec{F_L} = \dfrac{d\vec{p}}{dt} = q (\vec{E} + \vec{v} \times \vec{B}) \text{ ,}
    \label{equation:lorentz_force}
\end{equation}
where \(\vec{p}\) is the particle momentum, \(q\) the particle charge, \(\vec{E}\) the electric field, \(\vec{v}\) the particle velocity and \(\vec{B}\) the magnetic field.
In most accelerators, including the \gls{LHC}, the particles' speed is close to the celerity of light \(c\) and the force from the magnetic field is significantly stronger than that produced by the electric field for realistic values of \(\vec{E}\) and \(\vec{B}\).
As a result, while electric fields are used for acceleration, in high energy particle accelerators magnetic fields are typically used to guide particles.
The guiding magnetic field can be expanded into a series of multipolar fields, for instance here in the horizontal plane:

\begin{align}
    B_{y} = 
    \tikz[baseline]{
        \node[draw=red,rounded corners,anchor=base] (m1)
        {\(\displaystyle B_{y0}\)};
        \node[below of=m1] (l1) {dipole};
        \draw[-,red] (l1) -- (m1);
    }
    +
    \tikz[baseline]{
        \node[draw=red,rounded corners,anchor=base] (m2)
        {\(\displaystyle \frac{dB_{y}}{dx} x\)};
        \node[below of=m2] (l2) {quadrupole};
        \draw[-,red] (l2) -- (m2);
    }
    +
    \tikz[baseline]{
        \node[draw=red,rounded corners,anchor=base] (m3)
        {\(\displaystyle \frac{1}{2!} \frac{d^2B_{y}}{dx^2} x^2\)};
        \node[below of=m3] (l2) {sextupole};
        \draw[-,red] (l2) -- (m3);
    }
    +
    \tikz[baseline]{
        \node[draw=red,rounded corners,anchor=base] (m4)
        {\(\displaystyle \frac{1}{3!} \frac{d^3B_{y}}{dx^3} x^3\)};
        \node[below of=m4] (l2) {octupole};
        \draw[-,red] (l2) -- (m4);
    }
    + \ldots
    \label{equation:magnetic_field_expansion}
\end{align}

Bending forces are supplied by dipole magnets with a magnetic field perpendicular to the beam trajectory, while focusing is typically performed with the use of quadrupole magnets.
Higher orders belong to the non-linear dynamics and will be discussed later on in this chapter.
\Cref{figure:frenet_serret_system} illustrates the \concept{Frenet-Serret coordinate system} traditionally used in linear beam dynamics.

\begin{figure}[!htb]
    \centering
    \includegraphics[width=0.9\linewidth]{Figures/Beam_Dynamics_Theory/Frenet_Serret_Coordinate_System.png}
    \caption{The Frenet-Serret coordinate system used in accelerator physics. Here \(\hat{x}\), \(\hat{y}\), and \(\hat{s}\) form the right-handed orthogonal basis, while \(\rho\) is the local bending radius.}
    \label{figure:frenet_serret_system}
\end{figure}

The coordinate system travels longitudinally with the particle, along a reference trajectory defined by an ideal, or \gls{synchronous}, particle.
The longitudinal curvilinear coordinate is \(s\), and denotes the position of the particle along the ideal orbit with respect to an arbitrary initial point at \(s = 0\).
One can define a local radius of curvature, \(\rho(s)\), which depends on the local magnetic field \(\vec{B}\) and varies along the ring.
The transverse \concept{phase space} is defined by \((x, x^{\prime}, y, y^{\prime})\), where \(x\) and \(y\) are a particle's coordinates in the transverse planes relative to the reference trajectory.
The \(x^{\prime}\) and \(y^{\prime}\) coordinates are divergent angles, with the prime indicating differentiation with respect to \(s\).

In the linear regime, magnetic dipoles define the ideal orbit for a particle of \concept{reference momentum} \(p_0\).
This ideal orbit goes through the magnetic center of all elements in the machine to close back on itself after a revolution, and is called the \gls{closed_orbit}.
In practice however the real closed orbit will deviate from the ideal designed orbit due to various effects such as dipolar field errors, and the two are distinct.
Particles within the beam are distributed in amplitude and oscillate around the closed orbit, which corresponds to the path of a particle with zero amplitude within the beam, because of focusing forces. 
This is illustrated in \cref{figure:design_vs_particle_orbit} where a conceptualized design orbit, a closed orbit and an actual particle trajectory are shown.

\begin{figure}[!htb]
    \centering
    \includegraphics[width=0.95\linewidth]{Figures/Beam_Dynamics_Theory/design_vs_closed_vs_particle_orbit.pdf}
    \caption{Illustration of a design reference orbit (\textcolor{mplblue}{blue}), a closed orbit (\textcolor{mplorange}{orange}) and a single turn particle trajectory (\textcolor{red}{red}).}
    \label{figure:design_vs_particle_orbit}
\end{figure}

Focusing forces are typically provided by magnetic quadrupoles: a quadrupolar field acting on a charged particle displaced from the closed orbit will provide a restoring (focusing) force proportional to the displacement in one transverse plane, while simultaneously providing a diverging (defocusing) force in the other. 
As a convention, a quadrupole focusing in the horizontal plane and defocusing in the vertical one is referred to as a \concept{focusing quadrupole}. 
Respectively, a quadrupole defocusing in the horizontal plane but focusing in the vertical one is referred to as a \concept{defocusing quadrupole}.

A net focusing effect in both planes can be obtained with a setup of quadrupoles of alternating polarity in equal distance, a widely used configuration named the \concept{FODO cell}.
A schematic of a FODO cell is shown in \cref{figure:fodo_cell_schematic}, and \cref{figure:dipole_quadrupole_fields} illustrates magnetic fields in an \gls{LHC} dipole and quadrupole.

\begin{figure}[!htb]
    \centering
    \includegraphics[width=\linewidth]{Figures/Beam_Dynamics_Theory/fodo_cell_schematic.png}
    \caption{Schematic of a FODO cell. A focusing quadrupole is denoted with an F while a defocusing one is denoted with a D.}
    \label{figure:fodo_cell_schematic}
\end{figure}

For each magnet applying a field B one can define the \gls{beam-rigidity} \glssymbol{beam-rigidity}, which is an indication of the field's ability to alter a particle's course based on its charge \(q\) and momentum \(p\), as:

\begin{equation}
    \mathrm{B} \rho = \frac{p}{q} \text{ .}
    \label{equation:magnetic_rigidity}
\end{equation}

\begin{figure}[!hbt]
    \centering
    \begin{subfigure}[b]{0.495\textwidth}
        \centering
        % \includegraphics[width=\textwidth]{Figures/Beam_Dynamics_Theory/ideal_dipole_cos_theta.png}
        \includegraphics[width=\textwidth]{Figures/Beam_Dynamics_Theory/lhc_costheta_dipole.pdf}
        \caption{Magnetic dipole.}
        \label{fig:magnetic_dipole}
    \end{subfigure}
    \hfill
    \begin{subfigure}[b]{0.485\textwidth}
        \centering
        % \includegraphics[width=\textwidth]{Figures/Beam_Dynamics_Theory/ideal_quadrupole_cos_2theta.png}
        \includegraphics[width=\textwidth]{Figures/Beam_Dynamics_Theory/lhc_cos2theta_quadrupole.pdf}
        \caption{Magnetic quadrupole.}
        \label{fig:magnetic_quadrupole}
    \end{subfigure}
    \caption{Magnetic fields in an LHC dipole and quadrupole, with a \(\cos(\theta)\) and \(\cos(2\theta)\) current distribution in the circular coil, respectively. Currents in the dipole and quadrupole coils are indicated in color. These visuals were taken from \cite{CERN:Russenschuck:CAS_Design_Magnets}.}
    \label{figure:dipole_quadrupole_fields}
\end{figure}

\subsection{Equations of Motion and Twiss Parameters}
\label{subsection:equations_of_motion_and_twiss_parameters}

\begin{noteblock}
    The dynamics described in the material below apply similarly for both transverse planes.
    From now on, for clarity of the exposed expressions \(z\) will be used to denote either \(x\) or \(y\), and when explicitly needed a distinction will be made between the two transverse planes.
\end{noteblock}

The focusing from quadrupoles in a circular accelerator such as the \gls{LHC} is periodic in \(s\), with a period of at most the circumference of the machine.
Assuming the existence of a \gls{closed_orbit}, the transverse motion of a single particle in a synchrotron with a periodic lattice is described by \concept{Hill's equation}:

\begin{equation}
    z^{\prime \prime}(s) + K_z(s) z(s) = 0; \quad z = x, y; \quad z^{\prime} = \dfrac{dz}{ds} \text{ ,}
    \label{equation:hill_equation}
\end{equation}
where \(K_z\) represents the focusing effect of dipoles and quadrupoles in the transverse plane \(z\) and varies with \(s\) given that it is dictated by the magnetic elements traversed by particles.

\noindent
This focusing effect can be expressed according to:

\begin{equation}
	\begin{aligned}
		K_x(s) &= \frac{1}{\rho(s)^2} - k_1(s) \text{ ,} \\
    	K_y(s) &= k_1(s) \text{ ,}
	\end{aligned}
    \label{equation:transverse_focusing_strengths}
\end{equation}
where \(k_1(s)\) is the normalized quadrupole strength.
A \concept{focusing quadrupole} has a \(K > 0\), a \concept{defocusing quadrupole} has \(K < 0\), and a drift space has \(K = 0\).
The term \(\left(1 / \rho^2\right)\) in the horizontal component arises from the weak focusing caused by dipoles.

According to the theorem of Floquet~\cite{BOOK:Lee:Accelerator_physics}, the solution with periodic boundary conditions to Hill’s equation takes the form of \cref{equation:hill_solution}:

\begin{equation}
    \begin{aligned}
        z(s)          &= \sqrt{\beta_{z}(s) \varepsilon_{z}} \cos \left( \phi_{z}(s) + \phi_{z,0} \right) \text{ ,} \\
        z^{\prime}(s) &= -\sqrt{\frac{\varepsilon_z}{\beta_z(s)}} \left[ \sin \left(\phi_z(s) + \phi_{z, 0} \right) + \alpha(s) \cos \left( \phi_z(s) + \phi_{z, 0} \right) \right] \text{ .}
    \end{aligned}
    \label{equation:hill_solution}
\end{equation}
\vspace{0.5mm}

These equations describe a harmonic oscillation in the transverse planes.
Here \(\varepsilon_z\) is the \concept{geometric emittance} of a particle and is a constant of the motion at a given energy. 
The \(\phi_z(s)\) and \(\alpha_z(s)\) terms are the \concept{phase advance} and the \concept{alpha-function}, respectively.
\(\beta_z(s)\) is the \concept{beta-function} and represents the beam envelope, or size, around the ring.
It describes the transverse position dependent amplitude of the oscillation and has the dimension of a length.
In particle colliders such as the \gls{LHC} the \glspl{beta-function} at the \glspl{IP}, where the beams are made to collide, are commonly referred to as the \glssymbol{betastar}.
The solution of Hill's equation (\cref{equation:hill_equation}) can also be written in matrix form as:

\begin{equation}
    \begin{pmatrix}
        z \\
        z^{\prime}
    \end{pmatrix}_{s}
    = \mathrm{M}
    \begin{pmatrix}
        z \\
        z^{\prime}
    \end{pmatrix}_{0} \text{ .}
    \label{equation:hill_solution_matrix}
\end{equation}
\vspace{0.5mm}

In this form, which makes the assumption that the magnetic field of an element is constant along the longitudinal direction, M is called a \concept{transfer matrix}. 
Below are the transfer matrices corresponding to a drift space (\(\mathrm{M_{drift}}\)), a dipole (\(\mathrm{M_{dip.}}\)), a focusing quadrupole (\(\mathrm{M_{foc. quad.}}\)) and a defocusing quadrupole (\(\mathrm{M_{defoc. quad.}}\)), respectively:

\begin{equation}
    \mathrm{M_{drift}} = 
        \begin{pmatrix}
            1 & L \\
            0 & 1
        \end{pmatrix} \text{ ,}
    \label{equation:drift_transfer_matrix}
\end{equation}

\begin{equation}
    \mathrm{M_{dip.}} = 
        \begin{pmatrix}
            \cos \theta                                 & \rho \sin \theta \\
            \frac{-1}{\rho} \sin \left( \theta \right)  & \cos \theta
        \end{pmatrix} \text{ ,}
    \label{equation:dipole_transfer_matrix}
\end{equation}

\begin{equation}
    \mathrm{M_{foc. quad.}} = 
        \begin{pmatrix}
            \cos \left( \sqrt{k_1} L \right)             & \frac{1}{\sqrt{k_1}} \sin \left( \sqrt{k_1} L \right) \\
            -\sqrt{k_1} \sin \left( \sqrt{k_1} L \right) & \cos \left( \sqrt{k_1} L \right)
        \end{pmatrix} \text{ ,}
    \label{equation:focusing_quad_transfer_matrix}
\end{equation}

\begin{equation}
    \mathrm{M_{defoc. quad.}} = 
        \begin{pmatrix}
            \cosh \left( \sqrt{\abs{k_1}} L \right)                  & \frac{1}{\sqrt{\abs{k_1}}} \sinh \left( \sqrt{\abs{k_1}} L \right) \\
            \sqrt{\abs{k_1}} \sinh \left( \sqrt{\abs{k_1}} L \right) & \cosh \left( \sqrt{\abs{k_1}} L \right)
        \end{pmatrix} \text{ ,}
    \label{equation:defocusing_quad_transfer_matrix}
\end{equation}
\vspace{1.5mm}
where \(L\) is the element length and \(\theta = L / \rho\) is the bending angle of the dipole.

The above correspond to a \num{2}D case and should be appropriately used depending on the plane.
For instance, for a focusing quadrupole \(\mathrm{M_{foc. quad.}}\) (\cref{equation:focusing_quad_transfer_matrix}) should be used to transform the horizontal coordinates, and since the element will be defocusing in the vertical plane \(\mathrm{M_{defoc. quad.}}\) (\cref{equation:defocusing_quad_transfer_matrix}) should be used to transform the vertical coordinates.

Larger transfer matrices can be constructed in \num{4}D (or even \num{6}D when including the longitudinal coordinates) to be applied to \((x, x^{\prime}, y, y^{\prime})\) directly.
In the uncoupled case, this corresponds to a \(4 \times 4\) matrix with the respective \num{2}D transfer matrices on the diagonal and zeros elsewhere.
The \num{4}D transfer matrix of a \gls{normal} focusing quadrupole is then expressed as:

\begin{equation}
    \mathrm{M} = \begin{pmatrix}
        \mathrm{M_{foc. quad.}} & \begin{pmatrix}
                                    0 & 0 \\
                                    0 & 0
                                  \end{pmatrix} \\
            
        \begin{pmatrix}
            0 & 0 \\
            0 & 0
        \end{pmatrix}           & \mathrm{M_{defoc. quad.}}
        \end{pmatrix} \text{ .}
    \label{equation:4d_transfer_matrix}
\end{equation}
\vspace{0.5mm}

Some elements will have non-zero terms outside the diagonal in their transfer matrix.
This is the case of a \gls{skew} quadrupole for example, which gives a horizontal kick proportional to the vertical offset of the particle, and vice-versa.
This leads to \concept{coupled motion}, or \gls{betatron_coupling}, where the horizontal and vertical coordinates no longer evolve independently.
Betatron coupling will be discussed in more details later on, and for now only the \num{2}D case of a given plane will be considered.

The transfer matrix of a group of elements is obtained by multiplying the transfer matrices of all individual elements.
For example, the transfer matrix corresponding to the FODO cell of \cref{figure:fodo_cell_schematic} is:

\begin{equation}
    \mathrm{M_{FODO}} = \mathrm{M_{foc. quad.}} \cdot \mathrm{M_{drift}} \cdot \mathrm{M_{defoc. quad.}} \cdot \mathrm{M_{drift}} \text{ .}
    \label{equation:fodo_transfer_matrix}
\end{equation}

For a complete machine with hundreds to thousands of elements, the maps of linear elements can still be combined to obtain the coordinates of a particle after a full revolution.
This specific transfer map is called the \concept{one-turn map} and fully describes the linear evolution of a particle's coordinates over one revolution of the accelerator.
It can be expressed as:

\begin{equation}
    \mathrm{M_{OTM}} = \mathrm{M_N} \cdot \mathrm{M_{N-1}} \cdot \ldots \cdot \mathrm{M_2} \cdot \mathrm{M_1} \text{ ,}
    \label{equation:one_turn_map}
\end{equation}
where \(\mathrm{M_i}\) is the transfer matrix of the \(i\)th element in the machine.
The transformation of coordinates over a revolution is then given by:

\begin{equation}
    \begin{pmatrix}
        z \\
        z^{\prime}
    \end{pmatrix}_{s_0 + C} = \mathrm{M_{OTM}} \cdot \begin{pmatrix}
        z \\
        z^{\prime}
    \end{pmatrix}_{s_0} \text{ .}
    \label{equation:one_turn_coordinates_transformation}
\end{equation}

The phase advance \(\phi_z(s)\) mentioned above corresponds to the difference of the betatron phase functions at two points, typically also taken with respect to an arbitrary initial point at \(s = 0\).
The phase advance between two points at longitudinal positions \(s_1\) and \(s_2\) in the lattice is defined as:

\begin{equation}
    \phi_{s_1 \rightarrow s_2} = \phi(s_{2}) - \phi(s_{1}) = \int_{s_{1}}^{s_{2}} \frac{1}{\beta(s)} ds \text{ .}
    \label{equation:phase_advance_definition}
\end{equation}

As particles go around the ring, they oscillate around the closed orbit within an envelope defined by the \glspl{beta-function} and the emittance.
The number of these so-called \concept{betatron oscillations} per revolution is the \gls{tune} \(Q_z\).
The tune is defined in \cref{equation:tune_definition}, where \(\Delta \phi_{z}\) is the total betatron phase advance of a particle over a full circumference:

\begin{equation}
    Q_z = \frac{1}{2 \pi} \Delta \phi_z = \frac{1}{2 \pi} \oint_C \dfrac{ds}{\beta_z (s)} \text{ .}
    \label{equation:tune_definition}
\end{equation}

The \(\alpha\)-function is defined via the derivative of the \(\beta\)-function by:

\begin{equation}
    \alpha_z(s) = - \frac{1}{2} \beta^{\prime}_z(s) \text{ .}
    \label{equation:alpha_function}
\end{equation}

Similarly to the \(\beta\)-function, the \concept{gamma-function} \(\gamma_u(s)\) describes the envelope of oscillations in \(z^{\prime}\).
Both quantities are related by the \(\alpha\)-function according to:

\begin{equation}
    \gamma_z(s) = \frac{1 + \alpha_z^2(s)}{\beta_z(s)} \text{ .}
    \label{equation:gamma_function}
\end{equation}

The \(\alpha_z(s)\), \(\beta_z(s)\), \(\gamma_z(s)\) and \(\phi_z(s)\) are also called the \gls{Twiss_parameters}~\cite{RSI:Twiss:Orbital_Stability_Proton_Synchrotron}.
The transfer matrix can be expressed with Twiss parameters according to~\cite{AOP:COURANT:Theory_Alternating_Gradient_Synchrotron}:

\begin{equation}
    \mathrm{M} = \begin{pmatrix}
        m_{11} & m_{12} \\
        m_{21} & m_{22}
    \end{pmatrix}
    = 
    \begin{pmatrix}
        \cos \left( \phi_z \right) + \alpha_z \sin \left( \phi_z \right)  &  \beta_z \sin \left( \phi_z \right) \\
        - \gamma_z \sin \left( \phi_z \right)                             &  \cos \left( \phi_z \right) - \alpha_z \sin \left( \phi_z \right)
    \end{pmatrix} \text{ ,}
    \label{equation:transfer_matrix_twiss_parameters}
\end{equation}
where the \(s\) dependency of the Twiss parameters is omitted for simplicity.

\subsection{Phase Space Ellipse}
\label{subsection:phase_space_ellipse}

\begin{noteblock}
    Strictly speaking, the \((z, z^{\prime})\) plane forms the \concept{trace space} for the transverse coordinate \(z\) while the \((z, p_z)\) plane forms the \concept{phase space}.
    However, for monochromatic beams with constant momentum (e.g. no acceleration) the angular displacement \(z^{\prime}\) is linked to the transverse momentum \(p_z\) by \(p_z = \beta_r \gamma_r m_0 c z^{\prime}\), with \(m_0\) the particle's rest mass and \(\beta_r, \gamma_r\) the relativistic factors.
    Therefore, in the following we will consider trace space and phase space as equivalent and simply refer to \textit{phase space}.
\end{noteblock}

In the linear regime all particle trajectories describe ellipses in \((z, z^{\prime})\), or \((z, p_z)\) phase space.
The geometric emittance \(\varepsilon_z\) introduced in \cref{equation:hill_solution}, also named the \concept{Courant-Snyder invariant}, defines together with the \gls{Twiss_parameters} \(\alpha_z(s)\), \(\beta_z(s)\) and \(\gamma_z(s)\) the equation of the phase space ellipse:

\begin{equation}
    \gamma_z(s) z(s)^{2} + 2 \alpha_z(s) z(s) z^{\prime}(s) + \beta_z(s) z^{\prime}(s)^{2} = \varepsilon_z \text{ .}
    \label{equation:ellipse_equation}
\end{equation}
\vspace{0.3mm}

\Cref{figure:phase_space_ellipse} shows a schematic illustration of the phase space ellipse, the area \(A\) of which is defined by the geometric emittance according to:

\begin{equation}
    A = \pi \varepsilon_z \text{ .}
    \label{equation:phase_space_ellipse_area}
\end{equation}

\begin{figure}[!htb]
    \centering
    \includegraphics[width=\linewidth]{Figures/Beam_Dynamics_Theory/phase_space_ellipse.pdf}
    \caption{Phase space ellipse in the transverse \((z, p_z)\) plane, where \(z\) represents either transverse coordinate \(x\) or \(y\).}
    \label{figure:phase_space_ellipse}
\end{figure}

According to the \concept{Liouville theorem} the phase space volume - the ellipse area \(A\) - is a constant in a closed system.
When accelerating the beam this theorem no longer holds true and the geometric emittance \(\varepsilon_z\) will decrease as the beam energy increases.
One can then construct the \concept{normalized emittance}, which is invariant with beam energy, based on the relativistic beta and gamma:

\begin{equation}
    \varepsilon_z^{\mathrm{norm}} = \beta_{\mathrm{rel}} \gamma_{\mathrm{rel}} \varepsilon_z \text{ .}
    \label{equation:normalized_emittance}
\end{equation}

When referring to the emittance of a specific particle one uses the term \concept{single particle emittance}.
The \gls{action} \(J_z\) is related to the single particle emittance by:

\begin{equation}
    2 J_z = \varepsilon_z \text{ .}
    \label{equation:single_particle_action}
\end{equation}

The state of particles in phase space can be fully characterized by the action variable \(J_z\) and the corresponding phase variable \(\phi_z\) seen previously. 
Different particles in the beam will have different single particle emittances and will undergo betatron oscillations of varying amplitudes.
For a Gaussian shaped beam the transverse beam size is:

\begin{equation}
    \sigma_z = \sqrt{\beta_z \varepsilon_z^{\mathrm{beam}}} \text{ ,}
    \label{equation:gaussian_beam_transverse_beam_size}
\end{equation}
with \(\varepsilon_z^{\mathrm{beam}}\) the beam emittance, typically defined as the emittance corresponding to a \(1 \sigma\) amplitude of the Gaussian charge distribution.
In the case of more general particle distributions an alternative definition of the beam emittance is often used~\cite{CERN:Muller:Beam_Matter_Covariance_Matrix_Emittance, CAS:BuonBeam_Phase_Space_Emittance}:

\begin{equation}
    \varepsilon_z^{\mathrm{rms}} = \sqrt{\left\langle z \right\rangle^{2} \left\langle z^{\prime} \right\rangle^{2} - \left\langle zz^{\prime} \right\rangle^{2}} \text{ .}
    \label{equation:beam_emittance_general}
\end{equation}

The phase space trajectory of a particle depends on the \gls{Twiss_parameters} \(\alpha(s)\), \(\beta(s)\), and \(\gamma(s)\).
One can remove this dependency by performing a coordinate transformation to the \concept{Courant-Snyder coordinates}~\cite{BOOK:Bazzani:Normal_Form_Approach_Betatron_Motion}, defined as:

\begin{equation}
    \begin{pmatrix}
        \hat{z} \\
        \hat{z}^{\prime}
    \end{pmatrix}
    =
    \begin{pmatrix}
        \frac{1}{\sqrt{\beta_z}}         &  0 \\
        \frac{\alpha_z}{\sqrt{\beta_z}}  &  \sqrt{\beta_z}
    \end{pmatrix}
    \begin{pmatrix}
        z \\
        z^{\prime}
    \end{pmatrix} \text{ ,}
    \label{equation:physical_to_courant_snyder_coordinates}
\end{equation}
\vspace{1mm}

\noindent
where the Courant-Snyder coordinates are denoted with a hat \ \(\hat{ }\).
An identical transformation exists to go from \((z, p_z)\) to \((\hat{z}, \hat{p}_z)\) coordinates.
In this new system particles follow circular trajectories in phase space.
\Cref{figure:phase_space_linear_physical_normalized_coordinates} provides an illustrative representation of phase space in both physical and normalized coordinates for an accelerator with linear elements only.
In the new representation, the elliptical phase space is transformed into a simpler circular phase space where the motion corresponds to simple rotations, fully described by, and depending only on, the \gls{action} and angle variables \((J_z, \phi_z)\).
\vspace{3mm}

\begin{figure}[!hbt]
    \centering
    \begin{subfigure}[b]{0.475\textwidth}
        \centering
        \includegraphics[width=\textwidth]{Figures/Beam_Dynamics_Theory/phase_space_linear_physical.pdf}
        \caption{Physical coordinates.}
        \label{fig:phase_space_physical}
    \end{subfigure}
    \hfill
    \begin{subfigure}[b]{0.475\textwidth}
        \centering
        \includegraphics[width=\textwidth]{Figures/Beam_Dynamics_Theory/phase_space_linear_normalized.pdf}
        \caption{Normalized coordinates.}
        \label{fig:phase_space_normalized}
    \end{subfigure}
    \caption{Illustrative representation of phase-space in physical coordinates (left) and normalized, or Courant-Snyder, coordinates (right) for an accelerator with linear elements only. Courtesy of F. Carlier~\cite{PHD:Carlier}.}
    \label{figure:phase_space_linear_physical_normalized_coordinates}
\end{figure}

\subsection{Chromatic Effects}
\label{subsection:chromatic_effects}

Until now, it was assumed that all particles had the intended design momentum \(p_{0}\).
Naturally, in practice particles withing the beam have a distribution in energy and momentum.
For a particle with a momentum \(p \neq p_{0}\) one defines and uses the \concept{relative momentum deviation} \(\delta_p\):

\begin{equation}
    \delta_p = \frac{p - p_0}{p_0} = \frac{\Delta p}{p_0} \text{ .}
    \label{equation:momentum_deviation}
\end{equation}

Such momenta offsets introduce \concept{chromatic errors} in the beam dynamics.
Effects and parameters depending on \(\delta_p\) are called \concept{chromatic effects}.

From the definition of the \gls{beam-rigidity} in \cref{equation:magnetic_rigidity}, it follows that particles of different momenta will have different local radii of curvature when going through dipoles and therefore follow different orbits along the machine.
The orbit deviation of an off-momentum particle from that of the synchronous particle is defined by the \concept{dispersion function} \(D(s)\).
Its contribution to a particle's orbit in a region of non-zero dispersion is described by:

\begin{equation}
    \Delta z_{\mathrm{dispersion}} = D_z(s) \delta_p \text{ .}
    \label{equation:dispersion_contribution_to_orbit}
\end{equation}
\bigbreak

Off-momentum particle positions scale linearly with dispersion, and in its presence \cref{equation:hill_solution} is extended to~\cite{BOOK:Wiedemann:Particle_Accelerator_Physics}:

\begin{equation}
    z(s) = \sqrt{\varepsilon_z \beta_z(s)} \cos \left( \phi_z(s) + \phi_{z, 0} \right) + D_z(s) \delta_p \text{ .}
    \label{equation:hill_solution_with_dispersion}
\end{equation}
\vspace{0.5mm}

Another chromatic parameter is the \concept{chromaticity} \(Q_z^{\prime}\), which describes the tune shift \(\Delta Q_z\) with particle momentum by:

\begin{equation}
    Q^{\prime}_z = \frac{\Delta Q_z}{\delta_p} \text{ .}
    \label{equation:chromaticity_definition}
\end{equation}

The effective focusing strength of quadrupoles, which is inversely proportional to the momentum, differs for off-momentum particles.
The change of focusing strength due to energy deviation is:

\begin{equation}
	\Delta k_{1} = - \dfrac{e}{p^2} \dfrac{d B_{y}}{d x} \Delta p = -k_{1} \delta_p \text{ .}
    \label{equation:quadrupole_focusing_strength_deviation_from_dispersion}
\end{equation}

This quadrupole error results in a tune shift proportional to the energy offset:

\begin{equation}
	\Delta Q = \dfrac{1}{4 \pi} \int \beta(s) \Delta k_{1}(s) ds = \left[ - \frac{1}{4 \pi} \int \beta(s) k_{1}(s) ds \right] \delta_p \text{ .}
    \label{equation:tune_shift_from_dispersion}
\end{equation}
\vspace{0.5mm}

The natural chromaticity of a linear lattice can then be approximated by~\cite{CAS:Guiducci:Chromaticity}:

\begin{equation}
    Q_z^{\prime} \approx -\frac{1}{4 \pi} \oint \beta_z(s) K_z \mathrm{d}s \text{ .}
    \label{equation:natural_chromaticity_approximation}
\end{equation}

\section{Non-Linear Magnetic Multipoles}
\label{section:non_linear_magnetic_multipoles}

Magnetic fields of sextupolar and higher order are called \concept{non-linear} magnetic fields.
While only dipolar and quadrupolar magnetic fields are considered in the linear approximation, non-linear magnetic fields are present in most accelerators.
They can be introduced by design or by the presence of flaws in lower order magnets, the latter having the potential to seriously disrupt the beam.

\begin{noteblock}
    We label \(n\) the order of a multipole.
    This document uses the \textit{European convention} for field indices, in which \(n = 1\) corresponds to a magnetic dipole, \(n = 2\) to a quadrupole, etc.
\end{noteblock}

The magnetic field of a multipole of order \(n\) is given by:

\begin{equation}
    \begin{aligned}
    B_y(x, y, s) + i B_x(x, y, s) & = \sum_{n=1}^{\infty} \left[ B_n(s) + i A_n(s) \right] (x + i y)^{n-1} \text{ ,} \\
    B_n(s)                        & = \left. \frac{1}{(n - 1) !} \frac{\partial^{n - 1} B_y}{\partial x^{n - 1}} \right|_{(0,0,s)} \text{ ,} \\
    A_n(s)                        & = \left. \frac{1}{(n - 1) !} \frac{\partial^{n - 1} B_x}{\partial x^{n - 1}} \right|_{(0,0,s)} \text{ .} 
    \end{aligned}
    \label{equation:multipole_expansion}
\end{equation}

Here \(B_n(s)\) and \(A_n(s)\) are the \gls{normal} and \gls{skew} \concept{multipole coefficients}, respectively, where a skew magnet of order \(n\) is rotated by \(\pi / (2 n)\) with respect to its normal counterpart.
Starting from the Hamiltonian equations:

\begin{equation}
    \dfrac{d \vec{p_z}}{d t} = - \frac{\partial \mathcal{H}}{\partial \vec{z}} \text{ ,} \quad \quad \quad \dfrac{d \vec{z}}{d t} = \frac{\partial \mathcal{H}}{\partial \vec{p_z}} \text{ ,}
    \label{equation:hamiltonian_equations}
\end{equation}
the Hamiltonian for the transverse planes for a multipole of order \(n\) is given by \cref{equation:hamiltonian_multipole_order_n}~\cite{PHD:Tomas, PHD:Franchi}:

\begin{equation}
    \mathcal{H}_n = \frac{q}{p} \operatorname{Re} \left[ \left( B_n +i A_n \right) \frac{(x + i y)^n}{n} \right] \text{ .}
    \label{equation:hamiltonian_multipole_order_n}
\end{equation}

In the linear regime, this Hamiltonian may then be written as:

\begin{equation}
    \mathcal{H} = \frac{1}{2} p_x^2 + \frac{1}{2} p_y^2 + \frac{1}{2} K(s) x^2 - \frac{1}{2} K(s) y^2 \text{ ,}
    \label{equation:hamiltonian_linear_lattice}
\end{equation}
where \(K(s)\) describes the variation of the focusing strength around the ring.
More generally, if the Hamiltonian for a \gls{normal} multipole of order \(n\) is labeled \(N_n\) and that of a \gls{skew} multipole of order \(n\) is labeled \(S_n\), then~\cite{PHD:Maclean, PHD:Persson}:

\begin{equation}
    \begin{aligned}
        N_n & \propto \operatorname{Re} \left[(x + i y)^n \right] \\
            & \propto \operatorname{Re} \left[ \sum_{k=0}^n \begin{pmatrix} n \\ k \end{pmatrix} i^k \beta_x^{\frac{n-k}{2}} \beta_y^{\frac{k}{2}} \left(\sqrt{2 J_x} \cos\left(\phi_x\right) \right)^{n-k} \left( \sqrt{2 J_y} \cos\left(\phi_y\right) \right)^k \right] \text{ ,}
    \end{aligned}
    \label{equation:hamiltonian_prop_normal_multipoles}
\end{equation}

\begin{equation}
    \begin{aligned}
        S_n & \propto \operatorname{Im} \left[(x + i y)^n \right] \\
            & \propto \left[ \sum_{k=0}^n \begin{pmatrix} n \\ k \end{pmatrix} i^k \beta_x^{\frac{n-k}{2}} \beta_y^{\frac{k}{2}} \left(\sqrt{2 J_x} \cos\left(\phi_x\right) \right)^{n-k} \left( \sqrt{2 J_y} \cos\left(\phi_y\right) \right)^k \right] \text{ .}
    \end{aligned}
    \label{equation:hamiltonian_prop_skew_multipoles}
\end{equation}

The powering of non-linear magnets and the presence of magnetic errors can have a significant impact on the beam dynamics.
Geometric errors can also contribute to the presence of non-linear components.
For instance, when a particle does not pass through the magnetic center of an element it will see not only the primary field component but also perturbations of all lower orders to that of the traversed element~\cite{BOOK:Wiedemann:Particle_Accelerator_Physics}.
This effect is called \gls{feed-down} and can be introduced by misalignment of lattice elements, which would cause the closed orbit to deviate from the ideal one and the beam to pass off-axis in magnets.

Should that happen with a sextupole, for instance, the beam would experience a sextupolar field but also encounter quadrupolar and dipolar components.
The rotational misalignment of elements is also a concern, as rotating a purely normal or skew multipole results in the beam experiencing a combination of both normal and skew fields.

\section{Non-Linear Formalism and Resonance Driving Terms}
\label{section:non_linear_formalism_and_rdts}

The material below is inspired from~\cite{PHD:Tomas, PHD:Franchi,PHD:Maclean, PHD:Persson} where some aspects of it may be found in more details.
For the curious reader, a very thorough approach to normal forms can be found in~\cite{PHD:Carlier} and~\cite{PRAB:Franchi:First_Simultaneous}.

\subsection{Non-Linear Transfer Maps}
\label{subsection:non_linear_transfer_maps}

As introduced in \cref{equation:one_turn_map}, the dynamics of a circular accelerator can be parametrized in terms of \concept{transfer maps} relating final to initial phase space coordinates.
This approach is described in~\cite{BOOK:Bazzani:Normal_Form_Approach_Betatron_Motion, JMP:Forest:Hamiltonian_Free_Description_Single_Particle_Dynamics}.
While the transfer map of a linear element is described by a matrix, that of a non-linear element is itself described by the exponential \concept{Lie operator} \(e^{-:f:}\) defined as~\cite{BOOK:Wolski:Beam_dynamics}:

\begin{equation}
    \begin{aligned}
        e^{-:f:} g          &= g + \left[f, g\right] + \frac{1}{2} \left[f, \left[f, g \right] \right] + \ldots \text{ ,} \\
        \left[ f, g \right] &= \sum_i \frac{\partial f}{\partial q_i} \frac{\partial g}{\partial p_i} - \frac{\partial f}{\partial p_i} \frac{\partial g}{\partial q_i} \text{ ,}
    \end{aligned}
    \label{equation:lie_operator}
\end{equation}
where \(q_i\) and \(p_i\) are the canonical coordinates and momenta, respectively.
Here \(\left[ f, g \right]\) is the \concept{Poisson bracket} of \(f\) and \(g\).
When including non-linear sources, the one-turn map introduced in \cref{equation:one_turn_map} becomes:

\begin{equation}
    \mathrm{M_{OTM}} =e^{-:h_N:} e^{-:h_{N-1}:} \ldots e^{-:h_2:} e^{-:h_1:} R \text{ ,}
    \label{equation:one_turn_map_non_linear}
\end{equation}
where \(R\) is a matrix describing the linear dynamics of the machine, and the \(h_i\) terms represent the thin kick Hamiltonians of the non-linear elements in the accelerator.

Relevant properties of the exponential Lie operator can be found in~\cite{PHD:Tomas, PHD:Franchi}, one of which being that the product of exponential Lie operators can be expressed as another exponential Lie operator following the Baker-Campbell-Hausdorff theorem~\cite{BOOK:Hall:Lie_Group_Algebra_Representations}.
The one-turn map becomes:

\begin{equation}
    \mathrm{M_{OTM}} = e^{-:h:} R \text{ ,}
    \label{equation:Campbell_Baker_Hausdorff_theorem}
\end{equation}
in which, in case the \(h_i\) are small, \(h\) can be approximated as:
\begin{equation}
    h = \sum_{n=1}^N h_n + \sum_{n, m<n}^N \left[ h_m, h_n \right] + \ldots \text{ .}
    \label{equation:h_thin_kick_approximation}
\end{equation}

Using only the first order in \(h_n\), the thin kick \(h\) can be expressed in expanded terms using the action and angle variables according to~\cite{PHD:Franchi}:
% People might fight me on this but it makes sense with my derivation and it's the expression in Franchi's thesis

\begin{equation}
    h = \sum_{jklm} h_{jklm} \left( 2 J_x \right)^{\frac{j+k}{2}} \left( 2 J_y \right)^{\frac{l+m}{2}} e^{i \left[ \left(j-k\right) \left(\phi_x + \phi_{x,0} \right) + \left(l-m\right) \left(\phi_y + \phi_{y,0} \right) \right]} \text{ ,}
    \label{equation:h_thin_kick_expansion}
\end{equation}
with \(h_{jklm}\) being the \concept{Hamiltonian coefficient} encompassing the contribution of all multipoles of order \(n = j + k + l + m\). 
The derivation for the result of \cref{equation:h_thin_kick_expansion} can be found in \cref{appendix:hamiltonian_derivation}.
A multipole of order \(n = j + k + l + m\) gives rise to terms \(\propto x^{j+k} y^{l+m}\) in the Hamiltonian.
In the case of a \gls{skew} quadrupole (\(n=2\)) for example, one will see terms in the Hamiltonian \(\propto xy\), meaning a contribution to \(h_{1010}\), \(h_{1001}\), \(h_{0110}\) and \(h_{0101}\).

\subsection{Normal Form, Resonance Driving Terms and Resonances}
\label{subsection:normal_form_and_rdt}

Due to the presence of non-linear sources the linear invariant \(J_z\) introduced in \cref{subsection:phase_space_ellipse} is no longer a constant.
This leads to the phase space trajectory in normalized, or Courant-Snyder, coordinates no longer describing a circle.
An example of this situation is given in \cref{figure:phase_space_third_order_resonance}, where the horizontal phase space trajectories of \num{200} particles are shown in normalized coordinates when exciting a third order resonance.

\begin{figure}[!htb]
    \centering
    \includegraphics[width = 0.9\linewidth]{Figures/Beam_Dynamics_Theory/phase_space_third_order_resonance.pdf}
    \caption{Phase space in normalized coordinates from tracking \num{200} particles in a simple FODO-based lattice, when exciting a third order resonance. Points of each color corresponds to the trajectory of a given particle.}
    \label{figure:phase_space_third_order_resonance}
\end{figure}

One may wish to create a new transformation, akin to that to normalized coordinates, that would allow describing betatron motion in phase space by a pure rotation in the presence of non-linear sources.
The change of coordinates is represented by a similarity transformation of the one turn map, written as~\cite{PHD:Tomas}:

\begin{equation}
    e^{-:F:} e^{:h:} R e^{:F:} \text{ ,}
    \label{equation:normal_form_transformation}
\end{equation}
where \(F\) is the \concept{generating function} of the transformation.
The coordinates resulting from the transformation are called \concept{normal form coordinates}.
The different coordinate systems are illustrated in \cref{figure:phase_space_non-linear_physical_normalized_normal_form_coordinates}.

\begin{figure}[!hbt]
    \centering
    \begin{subfigure}[b]{0.30\textwidth}
        \centering
        \includegraphics[width=\textwidth]{Figures/Beam_Dynamics_Theory/phase_space_nonlinear_physical.pdf}
        \caption{Physical coordinates.}
        \label{fig:phase_space_physical_non-linear}
    \end{subfigure}
    \hfill
    \begin{subfigure}[b]{0.30\textwidth}
        \centering
        \includegraphics[width=\textwidth]{Figures/Beam_Dynamics_Theory/phase_space_nonlinear_normalized.pdf}
        \caption{Normalized coordinates.}
        \label{fig:phase_space_normalized_non-linear}
    \end{subfigure}
    \hfill
    \begin{subfigure}[b]{0.3805\textwidth}
        \centering
        \includegraphics[width=\textwidth]{Figures/Beam_Dynamics_Theory/phase_space_nonlinear_normal_form.pdf}
        \caption{Normal form coordinates.}
        \label{fig:phase_space_normal_form_non-linear}
    \end{subfigure}
    \caption{Illustrative exagerated representations of phase space in the three different coordinate systems: physical (left), normalized (middle) and normal form (right) coordinates. Courtesy of F. Carlier~\cite{PHD:Carlier}.}
    \label{figure:phase_space_non-linear_physical_normalized_normal_form_coordinates}
\end{figure}

The generating function of the transformation \(F\) contains a large portion of the information describing the non-linear dynamics, and a new non-linear invariant \(I_z\) can be introduced. 
Similarly to \(h\) in \cref{equation:h_thin_kick_expansion}, the generating function \(F\) can be expanded in terms of the normal form coordinates according to~\cite{PHD:Franchi}:

\begin{equation}
    F = \sum_{jklm} f_{jklm} \left( 2 I_x \right)^{\frac{j+k}{2}} \left(2 I_y \right)^{\frac{l+m}{2}} e^{i \left[ (j-k) \left( \psi_x + \psi_{x_0} \right) + (l-m) \left( \psi_y + \psi_{y_0} \right) \right]} \text{ ,}
    \label{equation:generating_function_expansion}
\end{equation}
where \((I_z, \psi_z)\) are to normal form coordinates what \((J_z, \phi_z)\) are to normalized coordinates.
The \(f_{jklm}\) coefficients are related to the \(h_{jklm}\) terms by:

\begin{equation}
    f_{jklm} = \frac{h_{jklm}}{1 - e^{i 2 \pi \left[ \left(j-k\right) Q_x + \left(l-m\right) Q_y \right]}} \text{ .}
    \label{equation:resonance_driving_terms}
\end{equation}

From \cref{equation:resonance_driving_terms} one can see that the \(f_{jklm}\) coefficients diverge for certain values of the tunes.
Specifically, divergence happens when the following relation is satisfied:

\begin{equation}
    \left(j-k\right) Q_x + \left(l-m\right) Q_y = p \quad \quad \text { where } j, k, l, m, p \in \mathcal{Z} \text{ .}
    \label{equation:resonance_condition}
\end{equation}

A divergence of the \(f_{jklm}\) terms leads to a divergence of the transformation to normal form coordinates, which generally indicates an unclosed phase space trajectory due to a \concept{resonance} in the beam motion.
The condition in \cref{equation:resonance_condition} corresponds to situations where particles lie on resonant frequencies, typically causing their amplitudes to grow unbounded by the dynamics.
Therefore the \(f_{jklm}\) terms are called \glspl{RDT}.

For this reason, the tune is one of the single most important design parameters in synchrotrons.
The chosen operational transverse tunes of a synchrotron are known as its \concept{working point}, and should be chosen carefully in order to avoid resonances.
Resonances up to order \(n = 5\) are shown in \cref{figure:tune_diagram_fifth_order}, with lines of different orders differentiated from one another.

\begin{figure}[!htb]
    \centering
    \includegraphics[width=\linewidth]{Figures/Beam_Dynamics_Theory/tune_diagram_fifth_order_with_working_points.pdf}
    \caption{Tunes diagram showing resonance lines up to order \(n = 5\). The LHC working points are indicated by the two dots: in \textcolor{wpblue}{blue} for injection tunes and \textcolor{wpred}{red} for collision tunes.}
    \label{figure:tune_diagram_fifth_order}
\end{figure}

Commonly, the label of a given resonance is written as \(\left( n_1, n_2 \right)\), where \(n_1 = \left( j - k \right)\) and \(n_2 = \left( l - m \right)\).
Every generating function term \(f_{jklm}\), and equivalently every Hamiltonian term \(h_{jklm}\), is associated with a specific resonance defined by the values of \(j\), \(k\), \(l\), and \(m\).

The \glspl{RDT} vary in amplitude through the machine as they depend on local multipole strength of contributing sources.
Characteristically, the \(f_{jklm}\) terms show abrupt jumps at the location of relevant sources.

\subsection{Resonance Basis and Normal Form Coordinates}

The normalized Courant-Snyder coordinates \(\left( \hat{z}, \hat{p}_z \right)\) are related to the action and angle variables \(\left( J_z, \phi_z \right)\) by:

\begin{equation}
    \begin{aligned}
        \hat{z}   &= \sqrt{2 J_z} \cos \left( \phi_z + \phi_{z_0} \right) \text{ ,} \\
        \hat{p}_z &= - \sqrt{2 J_z} \sin \left( \phi_z + \phi_{z_0} \right) \text{ .}
    \end{aligned}
    \label{equation:normalized_courant_snyder_coordinates_from_action_angle}
\end{equation}

One can define the \concept{resonance basis} \(\left( h_x^{+}, h_x^{-}, h_y^{+}, h_y^{-} \right)\) by the relation:

\begin{equation}
    h_z^{\pm} = \hat{z} \pm i \hat{p}_z = \sqrt{2 J_z} e^{\mp i \left( \phi_z + \phi_{z_0} \right)} \text{ .}
    \label{equation:resonance_basis_definition}
\end{equation}

The transformation to the \concept{normal form coordinates} introduced in the previous section, \(\left( \zeta_x^{+}, \zeta_x^{-}, \zeta_y^{+}, \zeta_y^{-} \right)\), is expressed as:

\begin{equation}
    \zeta_z^{\pm} = \sqrt{2 I_z} e^{\mp i \left( \psi_z + \psi_{z_0} \right)} = e^{-:F:} h_z^{\pm} \text{ .}
    \label{equation:transformation_to_normal_form_coordinates_from_h_pm}
\end{equation}
where \((I_z, \psi_z)\) are the terms introduced in \cref{equation:generating_function_expansion}.

By definition of the transformation, the one-turn map in normal form coordinates is an amplitude dependent rotation.
It follows that the motion of these coordinates as a function of the turn number \(N\) is then given by:

\begin{equation}
    \zeta_z^{\pm}(N) = \sqrt{2 I_z} e^{\mp i \left( 2 \pi Q_z N + \psi_{z_0} \right)} \text{ ,}
    \label{equation:normal_form_N_turn_expression}
\end{equation}
with \(Q_z\) the transverse tunes.
The inverse transformation from the new normal form coordinates to the resonance basis coordinates is written, to first order, as:

\begin{equation}
    h_z^{\pm} = e^{:F:} \zeta_z^{\pm} \simeq \zeta_z^{\pm} + \left[ F, \zeta_z^{\pm} \right] \text{ .}
    \label{equation:inverse_transformation_normal_form_to_courant_snyder_coordinates}
\end{equation}

Using \cref{equation:normal_form_N_turn_expression} and \cref{equation:inverse_transformation_normal_form_to_courant_snyder_coordinates}, the linearly normalized coordinates can be expressed after \(N\) turns as~\cite{PHD:Franchi,CERN:Bartolini:Normal_Form_Tracking_Beam_Data}:

\begin{equation}
    \begin{aligned}
        h_x^{-}(N) & = \sqrt{2 I_x} e^{i \left( 2 \pi Q_x N + \psi_{x_0} \right)} \quad - \\
        & \quad 2 i \sum_{jklm} j f_{jklm} \left( 2 I_x \right)^{\frac{j+k-1}{2}} \left( 2 I_y \right)^{\frac{l+m}{2}}   e^{i \left[ (1-j+k) \left( 2 \pi Q_x N + \psi_{x_0} \right) + (m-l)   \left( 2 \pi Q_y N - \psi_{y_0} \right) \right]} \\
        h_y^{-}(N) & = \sqrt{2 I_y} e^{i \left( 2 \pi Q_y N + \psi_{y_0} \right)} \quad - \\
        & \quad 2 i \sum_{jklm} l f_{jklm} \left( 2 I_x \right)^{\frac{j+k}{2}}   \left( 2 I_y \right)^{\frac{l+m-1}{2}} e^{i \left[ (k-j)   \left( 2 \pi Q_x N + \psi_{x_0} \right) + (1-l+m) \left( 2 \pi Q_y N - \psi_{y_0} \right) \right]} \text{ .}
    \end{aligned}
    \label{equation:linearly_normalized_coordinates_after_N_turns}
\end{equation}

\Cref{figure:coordinate_transformations} shows a schematic of the different transformations and changes to the one-turn map.
While one can calculate the evolution of the Courant-Snyder coordinates by applying the map \(\mathcal{M}\), the approach is complicated to solve in the presence of non-linearities.
Solving the one-turn map for the next turn is best done by performing a transformation to normal form coordinates \(\zeta_{z}^{\pm}\) using the generating function \(F\), applying the amplitude dependent rotation map \(R\), and transforming back to Courant-Snyder coordinates.
These calculations are in practice simpler than the former method, and conserve non-linearities.

\begin{figure}[!htb]
    \centering
    \begin{tikzpicture}
        \matrix (m) [matrix of math nodes,row sep=4em,column sep=4em,minimum width=2em]{
            \left(\hat{z}, \hat{p}_z\right)_N    &    \left(\hat{z}, \hat{p}_z\right)_{N+1} \\
            \zeta_{z_N}^{\pm}{}                  &    \zeta_{z_{N+1}}^{\pm}{}  \\
        };
        \path[-stealth]
        (m-1-1) edge node [above] {\( \mathcal{M} \)} (m-1-2)
        (m-1-1) edge node [left] {\( e^{:-F:} \)} (m-2-1)
        (m-2-1.east|-m-2-2) edge node [below] {\( e^{-:h:} R \)} (m-2-2)
        (m-2-2) edge node [right] {\( e^{:F:} \)} (m-1-2);
    \end{tikzpicture}
    \caption{Illustration of the coordinate transformations and change of the one-turn map. This diagram reads from Courant-Snyder coordinates at turn \(N\) in the top left, and shows both paths to reach the Courant-Snyder coordinates at turn \(N+1\) in the top right.}
    \label{figure:coordinate_transformations}
\end{figure}

\subsection{Spectral Contribution}
\label{subsec:spectral_contribution}

Each term in the summations of \cref{equation:linearly_normalized_coordinates_after_N_turns} corresponds to a certain mode in the beam motion and contributes to a specific frequency in the spectrum of the motion~\cite{PHD:Bengtsson}.
Said spectrum may be determined by a frequency analysis of the turn-by-turn beam position data, through means of a Fourier transform.
In this spectrum, an \gls{RDT} \(f_{jklm}\) at a specific location in the machine contributes to lines in the horizontal and vertical spectra according to~\cite{PHD:Bengtsson,PRAB:Franchi:Emittance_Sharing_Coupling}:

\begin{equation}
    \begin{aligned}
        H(1-j+k, m-l) &= 2 j \abs{f_{jklm}} \left( 2 I_x \right)^{\frac{j+k-1}{2}} \left( 2 I_y \right)^{\frac{l+m}{2}} \text{ ,}\\
        V(k-j, 1-l+m) &= 2 l \abs{f_{jklm}} \left( 2 I_x \right)^{\frac{j+k}{2}} \left( 2 I_y \right)^{\frac{l+m-1}{2}} \text{ ,}
    \end{aligned}
    \label{equation:rdt_contribution_to_spectrum_line}
\end{equation}
where in the parentheses multiples of the fractional tunes are given.
For example, \(H(0,1)\) indicates an observed line at \(1 \times Q_y\) in the horizontal spectrum.
% \Cref{figure:example_spectrum} shows an example of a spectrum from a measurement at the \gls{LHC}, where the main lines are highlighted.

In principle the \(\abs{f_{jklm}}\) may be determined by a comparison of the amplitude of various spectral lines.
In practice, some additional considerations need to be taken, as decoherence of a kicked beam can lead to a reduction in the amplitude of the spectral lines observed, or the fact that the contributions of different \glspl{RDT} might not be distinct.
More details are given in \cref{chapter:lhc_omc}.

\subsection{Amplitude Detuning}
\label{subsection:amplitude_detuning}

The \gls{ampdet} is the variation of the \gls{tune} with the single particle emittance.
It can be described with a Taylor expansion of the tune \(Q_z\) around the unperturbed tune \(Q_{z, 0}\) as:

\begin{equation}
    \begin{aligned}
    Q_z \left( \varepsilon_x, \varepsilon_y \right) & = Q_{z, 0} + \frac{\partial Q_z}{\partial \varepsilon_x} \varepsilon_x + \frac{\partial Q_z}{\partial \varepsilon_y} \varepsilon_y \\
                                                    & + \frac{1}{2!} \left(\frac{\partial^2 Q_z}{\partial \varepsilon_x^2} \varepsilon_x^2 + \frac{\partial^2 Q_z}{\partial \varepsilon_x \partial \varepsilon_y} \varepsilon_x \varepsilon_y + \frac{\partial^2 Q_z}{\partial \varepsilon_y^2} \varepsilon_y^2 \right) + \ldots \text{ ,}
    \end{aligned}
    \label{equation:tune_taylor_expansion}
\end{equation}
where \(\varepsilon_z = 2 J_z\) is the invariant of motion in the transverse plane \(z\).
The first order terms of the amplitude detuning, \(\frac{\partial Q_z}{\partial \varepsilon_x}\) and \(\frac{\partial Q_z}{\partial \varepsilon_y}\), are generated by octupoles and by the second order contribution of sextupoles~\cite{BOOK:Bazzani:Normal_Form_Approach_Betatron_Motion}; while the following terms come from higher order multipoles.
The amplitude detuning is a good indication of the machine non-linearities.

\section{Betatron Coupling}
\label{section:betatron_coupling}

When the betatronic motion of particles in transverse planes are independent of each other, they are said to be \concept{uncoupled}.
In particle colliders such as the \gls{LHC} this is the desired behaviour.
When these motions share a dependency, they are said to be \concept{coupled}, and one refers to this phenomenon as \gls{betatron_coupling}, or linear coupling.
The transverse motions of particles in an accelerator may couple due to a variety of factors, with solenoid and \gls{skew} quadrupole fields being the primary sources of linear coupling.

In the \gls{LHC} the main contribution to coupling comes from unwanted \gls{skew} quadrupolar fields.
These mostly arise from \gls{normal} quadrupoles mounted with a rotation error with respect to the longitudinal axis, but also from field imperfection from other magnets and feed-down from higher order magnets.
An example of a normal and skew quadrupole is given in \cref{figure:normal_vs_skew_quadrupole}.

\begin{figure}[!hbt]
    \centering
    \begin{subfigure}[b]{0.49\textwidth}
        \centering
        \includegraphics[width=\textwidth]{Figures/Beam_Dynamics_Theory/bfield_normal_multipole_order_2.pdf}
        \caption{Normal quadrupole.}
        \label{subfigure:normal_quadrupole}
    \end{subfigure}
    \hfill
    \begin{subfigure}[b]{0.49\textwidth}
        \centering
        \includegraphics[width=\textwidth]{Figures/Beam_Dynamics_Theory/bfield_skew_multipole_order_2.pdf}
        \caption{Skew quadrupole.}
        \label{subfigure:skew_quadrupole}
    \end{subfigure}
    \caption{Illustration of a \gls{normal} (left) and \gls{skew} (right) magnetic quadrupole and their magnetic field lines.}
    \label{figure:normal_vs_skew_quadrupole}
\end{figure}

\Gls{betatron_coupling} needs to be kept under control as it can perturb the tune feedback systems and push tunes into resonances, lead to a reduction in the dynamic aperture~\cite{PA:Ripken:Impact_Linear_Coupling_Nonlinear_Dynamics} or loss of beam stability~\cite{MASTERS:Soubelet:Optics_Octupole_PyHEADTAIL,PRAB:Carver:Transverse_Instabilities_With_Coupling}.

\subsection{Parametrization of Betatron Coupling}
\label{subsection:parametrization_of_betatron_coupling}

There are different ways to parametrize coupled motion in a particle accelerator, the two most common being the Edwards-Teng~\cite{IEEE:Edwards:Parametrization_Linear_Coupled_Motion} and Mais-Ripken~\cite{AIP:Willeke:Methods_Beam_Optics} parametrizations.
For coupled motion a dependency between the horizontal and vertical planes is introduced, and as mentioned in \cref{subsection:equations_of_motion_and_twiss_parameters} the transverse motions can no longer be described by two independent \(2 \times 2\) matrices.
Instead, it is described by a \(4 \times 4\) matrix \(\hat{\mathbf{M}}\) such that

\begin{equation}
    \hat{\mathbf{M}} = \begin{pmatrix}
        \mathbf{P} & \mathbf{p} \\
        \mathbf{q} & \mathbf{Q}
    \end{pmatrix} \text{ ,}
    \label{equation:coupled_motion_matrix}
\end{equation}
where \(\mathbf{P}\), \(\mathbf{p}\), \(\mathbf{q}\) and \(\mathbf{Q}\) are \(2 \times 2\) matrices.
In the absence of \gls{betatron_coupling}, it follows that \(\mathbf{p}\) and \(\mathbf{q}\) are \num{0}.
Magnetic elements introducing coupling between the horizontal and vertical planes have non-zero terms in the respective \(\mathbf{p}\) and \(\mathbf{q}\) of their transfer matrices.
For instance, the transfer matrix of a \gls{skew} quadrupole can be written

\begin{equation}
    \mathbf{M}_\mathrm{skew\ quad.} = \begin{pmatrix}
        \mathbf{M_x}    & \mathbf{M_{xy}}  \\
        \mathbf{M_{yx}} & \mathbf{M_y}   \\
    \end{pmatrix} \text{ ,}
    \label{equation:skew_quad_transfer_matrix}
\end{equation}
where, using \(\omega = \sqrt{k_{1s}} \ge 0\) for clarity, the various \(2 \times 2\) matrices are expressed as~\cite{Lecture:Wolski:Dynamical_Maps_Linear_Elements}:

\begin{equation}
    \begin{aligned}
        \mathbf{M_x} &= \begin{pmatrix}
            \frac{1}{2} \left( \cos \left(\omega L\right) + \cosh \left(\omega L\right)\right)        &  \frac{1}{2 \omega} \left( \sin \left(\omega L\right) + \sinh \left(\omega L\right)\right) \\
            -\frac{\omega}{2} \left( \sin \left(\omega L\right) - \sinh \left(\omega L\right)\right)  &  \frac{1}{2} \left( \cos \left(\omega L\right) + \cosh \left(\omega L\right) \right)
        \end{pmatrix} \text{ ,} \\
        \mathbf{M_{xy}} &= \begin{pmatrix}
            \frac{1}{2} \left( \cos \left(\omega L\right) - \cosh \left(\omega L\right)\right)        &  \frac{1}{2 \omega} \left( \sin \left(\omega L\right) - \sinh \left(\omega L\right)\right) \\
            -\frac{\omega}{2} \left( \sin \left(\omega L\right) + \sinh \left(\omega L\right)\right)  &  \frac{1}{2} \left( \cos \left(\omega L\right) - \cosh \left(\omega L\right)\right)
        \end{pmatrix} \text{ ,} \\
        \mathbf{M_{yx}} &= \begin{pmatrix}
            \frac{1}{2} \left( \cos \left(\omega L\right) - \cosh \left(\omega L\right)\right)              &  \frac{1}{2 \omega} \left( \sin \left(\omega L\right) - \sinh \left(\omega L\right)\right) \\
            -\frac{\omega}{2} \left( \sin \left(\omega L\right) + \sinh \left(\omega L\right)\right)  &  \frac{1}{2} \left( \cos \left(\omega L\right) - \cosh \left(\omega L\right)\right)
        \end{pmatrix} \text{ ,} \\
        \mathbf{M_y} &= \begin{pmatrix}
            \frac{1}{2} \left( \cos \left(\omega L\right) + \cosh \left(\omega L\right)\right)              &  \frac{1}{2 \omega} \left( \sin \left(\omega L\right) + \sinh \left(\omega L\right)\right) \\
            -\frac{\omega}{2} \left( \sin \left(\omega L\right) - \sinh \left(\omega L\right)\right)  &  \frac{1}{2} \left( \cos \left(\omega L\right) + \cosh \left(\omega L\right)\right)
        \end{pmatrix} \text{ .}
    \end{aligned}
    \label{equation:skew_quad_transfer_matrix_sub_matrices}
\end{equation}

\subsubsection*{Edwards-Teng Parametrization}

The effect of \gls{betatron_coupling} can, figuratively, be seen as a rotation of the beam ellipse.
In the Edwards-Teng parametrization presented in~\cite{IEEE:Edwards:Parametrization_Linear_Coupled_Motion}, the linear coupling is then described by a symplectic rotation \(\mathbf{R}\) of \(\hat{\mathbf{M}}\) into its normal modes form \(\overline{\mathbf{M}}\), as shown in \cref{equation:edwards_teng_parametrization}.
In this new frame the motion is decoupled, and all the information on the coupling is held by the matrix \(\mathbf{R}\).

\begin{equation}
    \overline{\mathbf{M}} = \left(
        \begin{array}{cc}
            \mathbf{X} & 0 \\
            0 & \mathbf{Y}
    \end{array} \right) = \mathbf{R} \hat{\mathbf{M}} \mathbf{R}^{-1} \text{ .}
    \label{equation:edwards_teng_parametrization}
\end{equation}

Edwards and Teng have characterized the transformation \(\mathbf{R}\) with the symplectic matrix:

\begin{equation}
    \mathbf{R} =\left(
        \begin{array}{cc}
            \mathbf{I} \cos \theta & -\mathbf{K}^{-1} \sin \theta \\
            \mathbf{K} \sin \theta & \mathbf{I} \cos \theta
    \end{array} \right) \text{ ,}
    \label{equation:edwards_teng_rotation_matrix}
\end{equation}
where \(\mathbf{I}\) is the \(2 \times 2\) unit matrix and \(\mathbf{K}\) is a \(2 \times 2\) symplectic matrix, such that \(det(\mathbf{K}) = 1\).
The coupled motion may then be described by the uncoupled \gls{Twiss_parameters} seen in \cref{subsection:equations_of_motion_and_twiss_parameters}, together with the elements of matrix \(\mathbf{K}\) and Teng's angle of rotation \(\theta\).
In the case that \(\theta = 0\), the matrix \(\mathbf{R}\) is the identity matrix and as a result it will not rotate any of the modes: this corresponds to uncoupled motion.

The Edwards-Teng parameterization is used in the \gls{MADX} code~\cite{CODE:MADX_guide} when handling coupled motion.
In \gls{MADX} the relevant parameters are \(\alpha_{x, y}\), \(\beta_{x, y}\), \(\mu_{x, y}\), \(\gamma_{x, y}\) and \(r_{11}\), \(r_{12}\), \(r_{21}\), \(r_{22}\), where \(r_{11} \ldots r_{22}\) correspond to the elements of \(\mathbf{K}\) multiplied by \(\tan(\theta)\).

\subsubsection*{Mais-Ripken Parametrization}

The approach of Mais and Ripken was developed in~\cite{REPORT:Ripken:AllGerman} and is more accessible in~\cite{AIP:Willeke:Methods_Beam_Optics, REPORT:Borchardt:Calculation_Beam_Envelopes}.
It defines so-called \concept{Ripken parameters} \(\alpha_{kj}\), \(\beta_{kj}\) and \(\gamma_{kj}\), where \(k = 1 \ldots 3\) refers to the plane (\(x, y, \ldots\)) and the index \(j\) refers to the eigenmodes, that are accurate in the presence of coupling.
In the coupled case, all \(\beta_N\) are non-zero and \(\beta_{11}, \beta_{22}\) are distinctively different from \(\beta_x, \beta_y\), respectively.
The relations linking these new parameters to the \gls{Twiss_parameters} can be found in~\cite{IOP:Lebedev:Betatron_Motion_Coupling}.
% The relations linking these new parameters to the Twiss parameters is~\cite{IOP:Lebedev:Betatron_Motion_Coupling}:

% \begin{equation}
%     \begin{aligned}
%     \beta_x &= \frac{\beta_{11}}{1-u} \text{ ,} \quad \alpha_x = \frac{\alpha_{11}}{1-u}, \\
%     \beta_y &= \frac{\beta_{21}}{1-u} \text{ ,} \quad \alpha_y = \frac{\alpha_{21}}{1-u},
%     \end{aligned}
%     \label{equation:ripken_to_twiss_parameters}
% \end{equation}
% where \(\sin \phi = \pm \sqrt{u}\) is the rotation of the x-y plane. When φ = 0 there is no coupling and β x = β 11
The Mais-Ripken parameterization is the basis of the \gls{PTC}~\cite{CODE:Schmidt_Forest:PTC}'s handling of coupled dynamics. 

\subsubsection*{Coupling and Beam Matrix}

Considering the \num{2}D case of a given transverse direction the so-called \concept{beam matrix} or \concept{sigma matrix}, which is the covariance matrix of the particle distribution, is expressed as:

\begin{equation}
    \sigma = \begin{pmatrix}
        \sigma_{11} & \sigma_{12} \\
        \sigma_{21} & \sigma_{22}
    \end{pmatrix} = \begin{pmatrix}
        \left\langle z^2 \right\rangle   & \left\langle z p_z \right\rangle   \\
        \left\langle p_z z \right\rangle & \left\langle p_{z}^2 \right\rangle
    \end{pmatrix}  \text{ .}
    \label{equation:2d_sigma_matrix}
\end{equation}
\vspace{1pt}

\noindent
where the brackets indicate an average over all particles in the beam.
Note that this matrix is symmetric with \(\sigma_{12} = \sigma_{21}\).

Considering that the \gls{Twiss_parameters} and the emittance defining the phase space ellipse are related to the various moments of the beam distribution as

\begin{equation}
    \begin{gathered}
        \epsilon_z = \sqrt{\left\langle z^2 \right\rangle \left\langle p_z^2 \right\rangle - \left\langle z p_z \right\rangle^2}  \text{ ,}  \\
        \beta_z    = \frac{\left\langle z^2 \right\rangle}{\epsilon_z}                                                            \text{ ,}  \\
        \alpha_z   = -\frac{\left\langle z p_z \right\rangle}{\epsilon_z}                                                         \text{ ,}  \\
        \gamma_z   = \frac{\left\langle p_z^2 \right\rangle}{\epsilon_z}                                                          \text{ ,}
    \end{gathered}
\end{equation}
one can relate them to the sigma matrix via the emittance through:

\begin{equation}
    \sigma = \varepsilon_z \begin{pmatrix}
        \beta_z & - \alpha_z \\
        - \alpha_z & \gamma_z
    \end{pmatrix}  \text{ .}
    \label{equation:2d_sigma_matrix_to_twiss_parameters}
\end{equation}
\vspace{1pt}

\noindent
When considering the full \num{4}D transverse space one can express the beam matrix \(\Sigma\) as a block diagonal \(4 \times 4\) matrix with the respective horizontal and vertical sigma matrices on the diagonal and zeros elsewhere.
In the presence of coupling, the general covariance matrix has non-zero terms outside its diagonal and takes the form of \cref{equation:4d_sigma_matrix}:

% See https://research.bangor.ac.uk/portal/files/28932262/untitled.pdf
\begin{equation}
    \Sigma = \begin{pmatrix} 
        \sigma_{11} & \sigma_{12} & \sigma_{13} & \sigma_{14} \\
        \sigma_{21} & \sigma_{22} & \sigma_{23} & \sigma_{24} \\
        \sigma_{31} & \sigma_{32} & \sigma_{33} & \sigma_{34} \\
        \sigma_{41} & \sigma_{42} & \sigma_{43} & \sigma_{44}
    \end{pmatrix} = \begin{pmatrix}
        \left\langle x^2 \right\rangle           &  \left\langle x p_x \right\rangle           &  \left\langle x y \right\rangle           &  \left\langle x p_y \right\rangle           \\
        \left\langle x p_x \right\rangle  &  \left\langle p_x^2 \right\rangle         &  \left\langle p_x y \right\rangle  &  \left\langle p_x p_y \right\rangle  \\
        \left\langle x y \right\rangle           &  \left\langle p_x y \right\rangle           &  \left\langle y^2 \right\rangle           &  \left\langle y p_y \right\rangle           \\
        \left\langle x p_y \right\rangle  &  \left\langle p_x p_y \right\rangle  &  \left\langle y p_y \right\rangle  &  \left\langle p_y^2 \right\rangle
    \end{pmatrix} \text{ .}
    \label{equation:4d_sigma_matrix}
\end{equation}
\vspace{1pt}

Through \(\Sigma\) the coupling can be characterized by the values of the cross-planes elements \(\left\langle x y \right\rangle\), \(\left\langle x p_y \right\rangle\), \(\left\langle p_x y \right\rangle\) and \(\left\langle p_x p_y \right\rangle\).
Through the symmetry (for instance, \(\left\langle x y \right\rangle = \left\langle y x \right\rangle\)) only those four terms are needed.

The angle of rotation \(\theta\) in the Edwards-Teng parametrization is related to these terms through~\cite{EPAC:Cai:Luminosity_of_Asymmetric_e+e-_Collider_with_Coupling_Lattices}:

% See: https://ados.web.psi.ch/opa/inside.pdf Eq. (37)
\begin{equation}
    \tan{2 \theta} = \frac{2 \Sigma_{xy}}{\Sigma_{xx} - \Sigma_{yy}} = \frac{2 \sigma_{13}}{\sigma_{11} \sigma_{33}} \text{ .}
    \label{equation:edwards_teng_theta_to_sigma_matrix_terms}
\end{equation}

In the Mais-Ripken parameterization, the Ripken parameters are constructed in order to be related to the \(\Sigma\) matrix in a similar way than shown in \cref{equation:2d_sigma_matrix_to_twiss_parameters} for the \num{2}D uncoupled case.

\subsection{Coupled Motion}
\label{subsection:coupled_motion}

In the first order, according to \cref{equation:resonance_condition}, linear coupling drives the two resonances \(Q_x + Q_y = p\) and \(Q_x - Q_y = p\), with \(p \in \mathcal{Z}\).
These are respectively called the \concept{sum and difference resonances}, and in their vicinity the beam dynamics are heavily influenced.
% To higher order \gls{betatron_coupling} may also give stationary terms in the Hamiltonian (a tune shift), driving the \(2 Q_x\) and \(2 Q_y\) resonances, but these effects are typically negligible.

The impact of linear coupling on the beam motion has been studied through Hamiltonian perturbation theory~\cite{PHREV:Guignard:Betatron_Coupling_Radiation,BOOK:Wiedemann:Particle_Accelerator_Physics}, and through the normal form and \gls{RDT} formalism~\cite{PHD:Franchi}.
As the transverse tunes approach the difference resonance, the emittance is described by:

\begin{equation}
    \varepsilon_x + \varepsilon_y = \mathrm{const} \text{ ,}
    \label{equation:coupled_emittances_difference_resonance}
\end{equation}
and as the resonance is approached the beam motion may not become unstable.
Instead, there is a periodic exchange of emittance between the transverse planes, which leads to a beating in the betatron oscillation amplitudes.

The relation between the \concept{unperturbed tunes} \((Q_x, Q_y)\) and the \concept{coupled tunes} \((Q_1, Q_2)\) is given by~\cite{CAS:Bryant:Theory_Weak_Betatron_Coupling}:

\begin{equation}
    \begin{aligned}
        Q_1 &= Q_x- \frac{\Delta}{2} + \frac{\sqrt{\Delta^2 + \abs{C^{-}}}}{2} \text{ ,} \\
        Q_2 &= Q_y+ \frac{\Delta}{2} - \frac{\sqrt{\Delta^2 + \abs{C^{-}}}}{2} \text{ ,}
    \end{aligned}
    \label{equation:unperturbed_tunes_to_coupled_tunes}
\end{equation}
with \(\Delta\) being the unperturbed fractional tune split and \glssymbol{Cminus} the linear coupling coefficient, a parameter describing the strength of the coupling.

When \(\Delta \gg \abs{C^{-}}\), away from the resonance, the observed oscillations modes \((Q_1, Q_2)\) are almost identical to the uncoupled tunes \((Q_x, Q_y)\).
When the tunes are moved closer together, approching the difference resonance (\(\Delta \rightarrow 0\)), the perturbed tunes are forced apart by the coupling and a minimal tune separation \(\Delta Q_{\mathrm{min}}\) can be observed.
The \glssymbol{Cminus} of \cref{equation:unperturbed_tunes_to_coupled_tunes}, named the \gls{Cminus}, corresponds this separation.
\Cref{figure:closest_tune_approach} shows an illustration of the phenomenon in the vicinity of the resonance, where both the unperturbed (dashed) and coupled (colored) fractional tunes are plotted against the uncoupled tune split.

\begin{figure}[!htb]
    \centering
    \includegraphics[width=0.9\linewidth]{Figures/Beam_Dynamics_Theory/closest_tune_approach_schematic.pdf}
    \caption{Illustration of coupled and uncoupled fractional tunes versus the uncoupled tune split. Courtesy of J. Keintzel~\cite{PHD:Keintzel}.}
    \label{figure:closest_tune_approach}
\end{figure}

On the other hand, when approaching the sum resonance the emittances follow:

\begin{equation}
    \varepsilon_x - \varepsilon_y = \mathrm{const} \text{ .}
    \label{equation:coupled_emittances_sum_resonance}
\end{equation}

This resonance allows for unstable motion as only the difference in emittance is constrained.
Therefore, it is common to choose a working point far from the sum resonance.
In the \gls{LHC}, the working points (visible on \cref{figure:tune_diagram_fifth_order}) are set such that the linear coupling is dominated by the difference resonance: the fractional tunes are \((Q_x, Q_y) = (0.28 \text{,} 0.31)\) at injection and \((Q_x, Q_y) = (0.31 \text{,} 0.32)\) for squeezed beams and collisions\footnote{The LHC working point is actually more diverse and will be discussed in more details in the next chapter.}.

\subsection{Linear Coupling Resonance Driving Terms}
\label{subsection:measurement_coupling_rdts}

Linear coupling in the \gls{LHC} is dominated by the contribution of \gls{skew} quadrupole fields, which lead to terms \(\propto xy\) in the Hamiltonian.
According to the resonance relation of \cref{equation:resonance_condition} and as seen in \cref{subsection:coupled_motion}, this gives rise to the \glspl{RDT} \(f_{1001}\) and \(f_{0110}\), which correspond to the \(Q_x - Q_y = p\) difference resonance; and \(f_{1010}\) which corresponds to the \(Q_x + Q_y = p\) sum resonance.

The \(f_{1001}\) and \(f_{0110}\) describe the same dynamics but the former is for the horizontal plane while the latter is for the vertical plane.
Since they describe the same dynamics it is custom to label both of them as \(f_{1001}\), which is a convention used throughout this document.

It was mentioned in \cref{subsection:coupled_motion} that the \gls{LHC} working point is selected to be close to the stable difference resonance, and as a consequence in the LHC the \(\abs{f_{1001}}\) dominates relative to the \(\abs{f_{1010}}\).
These \glspl{RDT} can be expressed as a function of the uncoupled lattice parameters at the location of both the coupling-contributing elements and the observation point \(s\) as~\cite{PHREV:Guignard:Betatron_Coupling_Radiation}:

\begin{equation}
    \begin{aligned}
        f_{1001}(s) &= - \frac{1}{4 \left(1 - e^{2 \pi i \left(Q_x - Q_y \right)}\right)} \sum_l k_l \sqrt{\beta_x^l \beta_y^l} e^{i \left(\Delta \phi_x^{s l} - \Delta \phi_y^{s l}\right)} \text{ ,} \\
        f_{1010}(s) &= - \frac{1}{4 \left(1 - e^{2 \pi i \left(Q_x + Q_y \right)}\right)} \sum_l k_l \sqrt{\beta_x^l \beta_y^l} e^{i \left(\Delta \phi_x^{s l} + \Delta \phi_y^{s l}\right)} \text{ ,}
    \end{aligned}
    \label{equation:coupling_rdts_from_skew_quads}
\end{equation}
where \(k_l\) is the \(l\)th integrated \gls{skew} quadrupole strength, \(\beta_{x,y}^{l}\) are the \glspl{beta-function} at the location of the \(l\)th skew quadrupole, \(Q_{x,y}\) are the horizontal and vertical tunes, and \(\Delta \phi_{x,y}^{s l}\) are the phase advances from the \(l\)th skew quadrupole to the observation point at the longitudinal coordinate \(s\).
The summation is done over all contributing \gls{skew} quadrupoles.

These \glspl{RDT} can be related to the strength of the coupling \(\Delta Q_{\mathrm{min}}\), and as such the \glssymbol{Cminus} can be expressed in relation to the \(f_{1001}\) \gls{RDT}.
In~\cite{PHD:Franchi} a simple version of this relation was established as:

\begin{equation}
    \abs{C^{-}} \approx 4 \Delta \frac{1}{N} \sum_{i=1}^N \abs{f_{1001}}_i \text{ ,}
    \label{equation:deltaqmin_from_f1001_franchi}
\end{equation}
where the summation is done over the \(N\) observation points, and \(\Delta\) is the fractional tune split.
A more accurate relation was established in~\cite{PRAB:Persson:Improved_Control_Betatron_Coupling}, which is:

\begin{equation}
    \abs{C^{-}} = \abs{\frac{4 \Delta}{2 \pi R} \oint d s f_{1001} e^{-i \left(\phi_x - \phi_y \right) + i s \Delta / R} } \text{ ,}
    \label{equation:deltaqmin_from_f1001}
\end{equation}
where the dependence of variables on the position \(s\) was omitted for clarity.

In~\cite{PHREV:Guignard:Betatron_Coupling_Radiation} the equations of motion are solved perturbatively under the influence of a weak \gls{skew} quadrupole strength \(j(s)\).
Assuming that the machine is close to the difference coupling resonance, \(\Delta = Q_x - Q_y \rightarrow 0\), the \glssymbol{Cminus} can be approximated as:

\begin{equation}
    \abs{C^{-}} = \frac{1}{2 \pi} \abs{ \oint ds \sqrt{\beta_x(s) \beta_y(s)} j(s) e^{-i \left( \phi_x - \phi_y \right) + i \frac{s \Delta}{R}} } \text{ ,}
    \label{equation:deltaqmin_guignard}
\end{equation}
where \(s\) is the position around the ring, \(\beta_{x,y}\) are the horizontal and vertical \(\beta\)-functions, \(\phi_{x,y}\) are the phase advances and \(R\) is the radius of the machine.

\section{Luminosity}
\label{section:luminosity}

The \gls{LHC} machine being a particle collider, it is operated to produce collisions between two counter-rotating beams and to produce data for \gls{HEP} \glspl{experiment}.
As the studied interactions coming from these collisions are rare, a substantial volume of statistics is required. 
Naturally, the performance of the machine is then described by the number of collisions provided to experiments as well as the center-of-mass energy of these collisions.

As a figure of merit for the number of collisions the \gls{luminosity} is used.
The \concept{instantaneous luminosity} \(\mathcal{L}\) is the proportional factor between the number of events per unit of time \(dR / dt\) and the process cross-section \(\sigma_{\mathrm{cross}}\):

\begin{equation}
    \dfrac{dR}{dt} = \mathcal{L} \sigma_{\mathrm{cross}} \text{ .}
    \label{equation:instantaneous_luminosity_definition}
\end{equation}

The instantaneous luminosity is given in units of inverse barns per second (\unit{\per\barn\per\second}), where \(\left[ b \right] = \) \qty{1e-24}{\square\centi\meter}.
For a collider with Gaussian beams, it can be expressed as~\cite{CERN:Herr:Concept_Luminosity}:

\begin{equation}
    \mathcal{L} = \frac{f_{\mathrm{rev}} N_1 N_2}{4 \pi \sigma_x \sigma_y} S \text{ ,}
    \label{equation:luminosity_gaussian_beams}
\end{equation}
where \(f_{\mathrm{rev}}\) is the revolution frequency of particle bunches, \(N_1\) and \(N_2\) are the number of particles in each beam, and \(\sigma_{x,y}\) are the transverse beam sizes at the interaction points.
\(S\) is the \concept{luminosity reduction factor} and depends on various parameters such as crossing angles, orbit offsets, beam-beam interactions, beam tilts in the case of \gls{flat_optics} etc.
For Gaussian bunches colliding with a \concept{crossing angle} \(\theta\), where \(\sigma_s \gg \sigma_{x,y}\) and neglecting other contributions, the luminosity reduction factor is approximated by~\cite{CERN:Herr:Concept_Luminosity}:

\begin{equation}
    S \approx \frac{1}{\sqrt{1 + \left( \frac{\theta}{2} \frac{\sigma_s}{\sigma_x} \right)^2}} \text{ .}
    \label{equation:luminosity_reduction_factor}
\end{equation}
\\
The luminosity can be influenced by the local presence of \gls{betatron_coupling} through its impact on beam size, as will be discussed in \cref{chapter:ir_local_coupling}.
As seen in \cref{equation:gaussian_beam_transverse_beam_size} the beam sizes directly depend on the \(\beta\)-function at the \gls{IP}, \glssymbol{betastar}, which then defines the collider's performance from the point of view of the optics.
Indeed, the smaller the \(\beta^{\ast}\) the smaller the beam sizes, and the more collisions will be produced per bunch crossing.

The \concept{integrated luminosity}, the accumulated luminosity over a given period of time, is given by:

\begin{equation}
    \mathcal{L}_{\mathrm{int}} = \int_{t_1}^{t_2} \mathcal{L} \mathrm{d}t \text{ .}
    \label{equation:integrated_luminosity}
\end{equation}

The integrated luminosity is usually in units of \unit{\per\femto\barn} \(=\) \qty{1e39}{\per\square\centi\meter}.
The total number of collisions, or events, over said time period is then:

\begin{equation}
    \mathrm{N_{events}} = \mathcal{L}_{\mathrm{int}} \sigma_{\mathrm{cross}} \text{ .}
    \label{equation:total_number_collisions}
\end{equation}

Throughout luminosity production, the instantaneous luminosity naturally decreases as more and more particles are lost to collisions~\cite{PRES:Hostettler:LHC_Lumi_Lifetime}.
Any particle losses happening before colliding the beams will lead to a reduction of the initial \(N_{1,2}\) and of the resulting integrated luminosity of the given fill.\\

\Gls{luminosity} production requires a good control of the linear optics, both for the quality of the optics themselves but also for a smooth and safe operation.
Many non-linear contributions may also influence the dynamics away from the linear regime, leading to a deterioration of the dynamics and, down the line, the luminosity.
Therefore for a particle collider like the \gls{LHC} a good control of all effects influencing the beam dynamics is required, and methods to both measure and correct any deviations from the ideal machine are a necessity.
An overview of these is given in \cref{chapter:lhc_omc}.

\glsresetall                                     % reset glossary entries counts for the next chapter
